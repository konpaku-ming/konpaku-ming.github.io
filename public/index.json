
[{"content":"helloï¼Œç±³å¨œæ¡‘~\né¸½çš„è¿™ä¹ˆå¤šå¤©é‡Œï¼Œä¸»è¦æ˜¯æ‘†çƒ‚ + æ‘†å¼„ä¸€äº›ï¼ˆåœ¨æˆ‘çœ‹æ¥ï¼‰æœ‰è¶£çš„ä¸œè¥¿ï¼Œå…¶ä¸­å°±åŒ…æ‹¬ LuaSTG ã€‚æˆ‘ç¬¬ä¸€æ¬¡å¬è¯´è¿™ç©æ„åº”è¯¥æ˜¯å› ä¸ºæŸéƒ¨åŒäººæ¸¸æˆï¼ˆå¤§æ¦‚ç‡æ˜¯ç¥ˆåæ¢¦ï¼‰ï¼Œä¹‹åä¹Ÿç©è¿‡ä¸€äº›ç®—æ˜¯ä¸ªäººåˆ¶ä½œçš„å° Mod ï¼Œä¸è¿‡æˆ‘å½“æ—¶æ²¡æœ‰è€ƒè™‘è¿‡è‡ªå·±åšç‚¹ STG ï¼ŒåŸå› ä¹Ÿå¾ˆç®€å•ï¼šå¤ªèœäº†ã€‚åš STG éœ€è¦æ‡‚å¼¹è®¾ï¼Œæ‡‚å¼¹è®¾ä¸€èˆ¬é£æœºæŠ€æœ¯ä¸ä¼šå¤ªå·®ï¼Œä½†æ˜¯æˆ‘è¿˜å›°åœ¨å¦–Eï¼ˆå¥½åƒè¦ç­‰åˆ°å¤§ä¸€ä¸‹æ‰é€šğŸ˜€ï¼‰ã€‚\nå¤§å­¦åæ—¶é—´æ€»å½’æ¯”é«˜ä¸­å¤šä¸€ç‚¹ï¼Œä¸è¿‡ STG å¼ºåº¦åº”è¯¥æ˜¯è¿œä¸å¦‚ä¹‹å‰çš„ã€‚ä»¥å‰åŸºæœ¬æ¯å‘¨ä¼šæ‰“ä¸€æŠŠï¼Œè¿™ä¸ªæ—¶é—´ç°åœ¨å˜æˆäº†ä¸€ä¸ªæœˆã€‚å¤§ä¸€ä¸Šå¿ƒè¡€æ¥æ½®ï¼ˆå¿˜è®°æ˜¯ä¸æ˜¯æœŸä¸­ç»™æˆ‘å¿ƒæ€å¹²å´©äº†ï¼‰æœ‰æ®µæ—¶é—´ç‹‚ç»ƒæ°¸Nï¼Œæ‹¿å•é­”ç†æ²™è¿˜çœŸæ‰“å‡ºäº†ç¬¬ä¸€ä¸ª N ï¼Œä¸è¿‡åæ¥ä¹Ÿæ²¡ä»€ä¹ˆçƒ­æƒ…ï¼Œç›´åˆ°æš‘å‡é‚£ä¼šå¼€è‡ªåŠ¨é›·æ··å…³å†²å…¨Nï¼ˆåæ”¾å¼ƒï¼Œæ˜Ÿè²èˆ¹æ‰‹æ®µæå…¶å‡¶æ®‹ï¼‰ã€‚å¤§ä¸€ä¸Šçš„å¯’å‡å…¶å®æœ‰è·Ÿäººçº¦ç€åšä¸€ä¸ªå°çš„å•å…³ï¼Œç„¶è€Œæˆ‘å½“æ—¶å¤ªé¸½äº†ï¼ŒåŠ ä¸Šå‡ä¹Ÿä¸é•¿ï¼Œæœ€åè¿æ–‡ä»¶å¤¹éƒ½æ²¡å»ºï¼ˆç¬‘ï¼‰ã€‚æœ€è¿‘æƒ³ç€ç¨å¾®ç©ä¸€ç©å§ï¼Œè¿˜èƒ½ç”¨ AI å†™å¼¹å¹•ä»£ç ï¼Œä»Šå¤©ç®—æ˜¯ç»ˆäºåšå‡ºæ¥ä¸€å¼ ç¬¦å¡å§ï¼Œå°±å†™ä¸€ç¯‡çºªå¿µä¸€ä¸‹ã€‚\nBefore Reading\r#\ræˆ‘æƒ³ä»¥å‡ é¦–æ­Œä½œä¸ºè‡ªåˆ¶å¼¹å¹•çš„ä¸»é¢˜ï¼Œç¬¬ä¸€ä¸ªå°±æ˜¯ç«¹ä¹‹èŠ±ã€‚\nå¦‚æœä¸çŸ¥é“å‰§æƒ…çš„è¿˜æ˜¯å¾ˆæ¨èå»çœ‹çœ‹åŸç¯‡çš„ã€‚æˆ‘ä¸€ç›´å¾ˆæ¨å´‡ç”¨æœ‰é™çš„ç¯‡å¹…è§¦åŠ¨äººçš„ä½œå“ï¼Œç«¹ä¹‹èŠ±åšåˆ°äº†ã€‚\nè™½ç„¶åæ¥å¬åˆ°è¿™é¦–æ­Œå¤šæ˜¯ä»¥äºŒå€é€Ÿçš„å½¢å¼äº†ï¼ˆéš¾è§†ï¼‰ã€‚\nFirst Spell Card\r#\rå…¶å®ä¹‹å‰ï¼ˆ 29 å·ï¼‰ä¸ºäº†ç†Ÿæ‚‰ä¸€ä¸‹ Editor Sharp æ€ä¹ˆæ­é… AI é£Ÿç”¨ï¼Œå·²ç»åšè¿‡ä¸€å¼ ç¬¦å¡äº†ï¼Œä¸è¿‡é‚£ä¸ªçº¯å± AI åˆ›æ„ã€‚\nä¸‹é¢è¿™å¼ ç¬¦å°±æ˜¯ç¬¦å¡ã€Œç«¹ãƒèŠ±ã€ï¼Œæˆ‘çš„æœ€åˆæ„æƒ³æ˜¯è®©ç»¿è‰²ç±³å¼¹æ¨¡æ‹Ÿç«¹å­ï¼Œä»ç‰ˆåº•å‘ä¸Šé•¿ï¼Œæœ€ååœ¨æœ«ç«¯å¼€èŠ±ã€‚æœ€åç«¹å­å¼¹å¹•æ¶ˆå¤±ï¼ŒèŠ±é›¨æ•£è½ã€‚\nç”±äº 1 æœˆ Github Copilot çš„é¢åº¦è¢«æˆ‘åš CPU å’Œæ­ç½‘ç«™çƒ§å®Œäº†ï¼Œåªèƒ½ç”¨ä¸€äº›å¾ˆæçš„æ¨¡å‹ã€‚ç«¹å­çš„å¤„ç†ä¸€ç›´æ„Ÿè§‰ä¸å¤ªåƒï¼Œæœ€åç”¨ä¸¤æ’ç»¿è‰²ç±³å¼¹é”™ä½å¹¶æ’ï¼Œæ„Ÿè§‰å·®ä¸å¤šå°±å¦¥åäº†ã€‚ä¸€å¼€å§‹åšçš„ç«¹èŠ±å¤ªç¨€ç–äº†ï¼Œéƒ½çœ‹ä¸å‡ºèŠ±çš„å½¢çŠ¶ï¼Œåæ¥æƒ³åšæˆå›¢ç°‡çš„å½¢å¼ï¼Œä½†æ˜¯å¼¹å¹•é‡å°±æœ‰äº›ç¦»è°±ï¼Œè€Œä¸”ä¸Šé¿çš„éš¾åº¦æœ‰ç‚¹å°ï¼Œå˜æˆçº¯å§¿åŠ¿äº†ã€‚åæ¥ä¹Ÿç®—æ˜¯å¦¥ååšæˆè¿™æ ·ï¼Œæ˜¯è®©ä¸­å¿ƒç›¸å¯¹å¯†ä¸€ç‚¹ï¼Œä½†æ˜¯åˆå‘å¤–æœ‰ä¸€ç‚¹å»¶ä¼¸ï¼Œä¸è‡³äºç”»é¢å¤ªç©ºã€‚\nä¸‹é¢æ˜¯ AI å†™çš„ä»£ç ï¼Œä¸­é—´è°ƒäº†å¾—æœ‰å‡ åæ¬¡ã€‚æ˜å¤©å°±äºŒæœˆäº†ç­‰æˆ‘æ¢æ¨¡å‹~\nlasttask = task.New(self, function() task.MoveTo(0, 160, 60, MOVE_NORMAL) local rng = Rand() local timer = 0 while true do self.x = 20 * sin(timer * 1.0) for i = 1, 4 do local base_x = -150 \u0026#43; (i - 1) * 100 task.New(self, function() local bamboo_parts = {} local current_flowers = {} local function grow_logic(sx, sy, s_angle, depth, max_j, parts, flowers) local curr_x, curr_y = sx, sy local ang = s_angle for j = 1, max_j do ang = ang \u0026#43; rng:Float(-1.0, 1.0) if ang \u0026lt; 80 then ang = 80 elseif ang \u0026gt; 100 then ang = 100 end local step = 10 local next_x = curr_x \u0026#43; step * cos(ang) local next_y = curr_y \u0026#43; step * sin(ang) local b1 = New(_straight, grain_b, COLOR_GREEN, curr_x, curr_y, 0, ang, false, 0, true, true, 0, false, 0, 0, 0, false) local b2 = New(_straight, grain_b, COLOR_GREEN, curr_x \u0026#43; 5*cos(ang), curr_y \u0026#43; 5*sin(ang), 0, ang, false, 0, true, true, 0, false, 0, 0, 0, false) table.insert(parts, b1) table.insert(parts, b2) -- --- ã€æ–°å¢ï¼šç«¹å¶ç”Ÿé•¿é€»è¾‘ã€‘ --- -- ä¸»å¹²æ¯ 6 èŠ‚é•¿å¶ï¼Œä¾§æåœ¨ä¸­é—´é•¿å¶ if (depth == 0 and j % 6 == 0 and j \u0026lt; max_j - 5) or (depth \u0026gt; 0 and j == 6) then local leaf_side = (rng:Float(0,1) \u0026gt; 0.5 and 1 or -1) for k = 1, 2 do -- æ¯æ¬¡æˆç°‡é•¿å‡º 2 ç‰‡å¶å­ local leaf_ang = ang \u0026#43; leaf_side * rng:Float(40, 70) local leaf = New(_straight, grain_a, COLOR_DEEP_GREEN, curr_x, curr_y, 0, leaf_ang, false, 0, true, true, 0, false, 0, 0, 0, false) table.insert(parts, leaf) leaf_side = leaf_side * -1 -- å·¦å³äº¤é”™æˆ–å¯¹ç§° end end if depth == 0 and j == 26 then local side = (rng:Float(0, 1) \u0026gt; 0.5 and 1 or -1) task.New(self, function() grow_logic(curr_x, curr_y, ang \u0026#43; side * 30, depth \u0026#43; 1, 12, parts, flowers) end) ang = ang - side * 8 end -- ã€é«˜å¯†åº¦çº¢è‰²ä¸­å¿ƒèŠ±ç°‡ã€‘ if j \u0026gt;= (max_j - 1) then local bloom_intensity = 18 \u0026#43; (j - (max_j - 1)) * 4 for n = 1, bloom_intensity do local raw_r = sqrt(rng:Float(0, 1)) * 35 local offset_a = rng:Float(0, 360) local fx = curr_x \u0026#43; (raw_r * 1.2) * cos(offset_a) local fy = curr_y \u0026#43; (raw_r * 0.8) * sin(offset_a) local f_type = (rng:Float(0, 1) \u0026gt; 0.7) and grain_a or ball_small local f_color = (f_type == grain_a) and COLOR_PURPLE or COLOR_RED local flower = New(_straight, f_type, f_color, fx, fy, 0, rng:Float(0, 360), false, 0, true, true, 0, false, 0, 0, 0, false) table.insert(flowers, flower) end end curr_x, curr_y = next_x, next_y task.Wait(4) end end grow_logic(base_x, -260, 90, 0, 46, bamboo_parts, current_flowers) task.Wait(30) task.New(self, function() for k = 1, #bamboo_parts do if IsValid(bamboo_parts[k]) then Del(bamboo_parts[k]) end if k % 30 == 0 then task.Wait(1) end end end) task.Wait(40) for _, flower in ipairs(current_flowers) do if IsValid(flower) then task.New(flower, function() local weight = rng:Float(0, 1) local gravity = 0.005 \u0026#43; (weight * 0.015) flower.vx, flower.vy = rng:Float(-0.4, 0.4), -rng:Float(0, 0.2) * weight local wind_sense = (1.2 - weight) * rng:Float(0.02, 0.04) local friction = 0.97 \u0026#43; (weight * 0.02) while IsValid(flower) do flower.vy = flower.vy - gravity flower.vx = (flower.vx \u0026#43; wind_sense * sin(timer * 2.5 \u0026#43; rng:Float(0, 360))) * friction if flower.vy \u0026lt; -3.5 then flower.vy = -3.5 end task.Wait(1) end end) end end end) end task.Wait(320) timer = timer \u0026#43; 1 end end) é‚£ä¸ªæ³¨é‡Šé‡Œå†™çš„ä»€ä¹ˆç«¹å¶ï¼Œæˆ‘çœ‹ä¸Šå»æ›´åƒæ˜¯ç«¹èŠ‚ï¼Œä¹Ÿå°±å¹²è„†åšæˆæ·±ç»¿è‰²äº†ã€‚\nFinal Scene\r#\rç›´æ¥æ”¾Bç«™é“¾æ¥äº†ï¼Œä¼ é€é—¨ã€‚\né¿å¼¹çš„åšæ³•æ˜¯æ‰¾åˆ°äº†çµæ¢¦æœºä½“çš„ .lua æºç ï¼Œåœ¨é‡Œé¢æŠŠçµæ¢¦çš„ frame() å‡½æ•°æ¢æ‰äº†ã€‚å¤§è‡´é€»è¾‘æ˜¯æ¯ä¸ªå¼¹å¹•ç»™ä¸€å®šæ–¥åŠ›ï¼Œè¿˜è¦æ³¨æ„æŠŠè‡ªæœºæ‹‰å›ç‰ˆåº•ä¸­éƒ¨ï¼Œä¸ç„¶ä¼šå¾ˆå®¹æ˜“é£˜åˆ°è§’è½è¢«å°æ­»ã€‚\nä¹‹åä¼šç»§ç»­åšä¸€äº›ç¬¦å¡ï¼Œå†çœ‹çœ‹èƒ½ä¸èƒ½ä¼˜åŒ–è¿™ä¸ªé¿å¼¹é€»è¾‘ï¼Œæˆ–è®¸çœŸè¦åšæˆä¸€ä¸ªå°é¡¹ç›®å‘¢\u0026hellip;\nSomething Unrelated\r#\r29 å·ä¸œæ–¹è¿·å®« 3 å‡ºäº†ï¼Œå¬è¯´æ±‰åŒ–å¯èƒ½è¿™ä¸¤å¤©èƒ½å¥½ï¼Œåé¢å¿…é¡»è¦å°å°å’¸æ·¡äº†ã€‚\næœ€è¿‘ç¡å¾—å¥½æ™šï¼ˆèµ·å¾—ä¹Ÿå¥½æ™šï¼‰ï¼Œæ„Ÿè§‰ç²¾ç¥æœ‰äº›èé¡å•Šï¼Œè°ƒä½œæ¯å§è°ƒä½œæ¯ã€‚\n","date":"31 January 2026","externalUrl":null,"permalink":"/posts/playing-luastg/","section":"Posts","summary":"","title":"Playing LuaSTG...","type":"posts"},{"content":"","date":"31 January 2026","externalUrl":null,"permalink":"/posts/","section":"Posts","summary":"","title":"Posts","type":"posts"},{"content":"","date":"31 January 2026","externalUrl":null,"permalink":"/","section":"Youming's Gensokyo","summary":"","title":"Youming's Gensokyo","type":"page"},{"content":"è¿™å‡ å¤©æ¯”è¾ƒå‹¤å¥‹å“ˆï¼Œå¹²è„†å†æ›´ä¸€ç¯‡ã€‚\næœ€å¼€å§‹åš CPU M-Extension çš„æ—¶å€™ï¼Œæ˜¯æƒ³å®ç° SRT é™¤æ³•çš„ï¼Œä½†æ˜¯è®© copilot è°ƒäº†å¾ˆä¹…ï¼Œçƒ§äº†å¾ˆå¤š token éƒ½è¿˜æ˜¯æœ‰é—®é¢˜ã€‚åŠ ä¸Šè‡ªå·±å…¶å®ä¹Ÿä¸ä¼šï¼ˆå¿ƒè™šï¼‰ï¼Œæœ€åè¿˜æ˜¯å†™äº†ä¸€ä¸ªç®€å•çš„ Radix-16 æ¢å¤é™¤æ³•ã€‚é‚£ä¸ªé™¤æ³•å™¨çš„è®¾è®¡è¿‡äºææ€–ï¼Œæˆ‘ç›´æ¥æ‹¿å½“å‰ä½™æ•° $R$ å’Œ 1~15 å€çš„ $d$ å¹¶è¡Œç›¸å‡æ¯”è¾ƒæ¥ç¡®å®šå•†ä½ã€‚ä¸è¿‡å¥½åƒå¤§å®¶ä¹Ÿéƒ½ä¸æ˜¯å¾ˆåœ¨æ„è¿™ä¸ªï¼Œä¸¤è½® cr éƒ½æ²¡æœ‰äººæ¥æ‹·æ‰“è¿™ä¸ªæ²Ÿæ§½çš„è®¾è®¡ã€‚\nXiangShan çš„ä»£ç ä¸­ï¼ˆ nanhu ç‰ˆï¼‰åšäº†å¥½å‡ ä¸ªé™¤æ³•å™¨ï¼Œæœ¬æ–‡ä¸»è¦åŸºäºå…¶ä¸­çš„ SRT4Dividerã€‚ä¸è¿‡æˆ‘ä»¬çš„é‡å¿ƒä¼šè¿˜æ˜¯æ”¾åœ¨ SRT é™¤æ³•çš„åŸç†ä¸Šï¼Œä¸ä¼šæ¶‰åŠåˆ°å¯¹ä»£ç çš„è¯¦ç»†è®²è§£ã€‚\nBefore Reading\r#\rä¾ä¸ªäººè§‚ç‚¹ï¼Œå†™ä»£ç æ—¶é€‚åˆå¬ vocal ï¼Œçœ‹æ•°å­¦æ—¶é€‚åˆå¬çº¯éŸ³ï¼ˆé›¾ï¼‰ã€‚\nè€ƒè™‘åˆ° AV2 å¯¹æˆ‘å…¥å‘è½¦ä¸‡çš„å½±å“ï¼Œè¿™é¦–æ­Œç¡®å®ç®—æ˜¯æˆ‘åˆå…¥å¹»æƒ³ä¹¡çš„åœ°æ–¹äº†\u0026hellip;\nWhy SRT\r#\rå¦‚æœä½ å¯¹æ¢å¤é™¤æ³•å’Œéæ¢å¤é™¤æ³•ä¸äº†è§£ï¼Œæœ€å¥½å»æ¶è¡¥ä¸€ä¸‹ç›¸å…³çŸ¥è¯†ã€‚æ³¨æ„ç”„åˆ«å†…å®¹ï¼Œæˆ‘åœ¨çœ‹éæ¢å¤é™¤æ³•æ—¶ï¼Œæœ‰ä¸€ä¸ªå¸–å­æŠŠ wiki ä¸Šçš„ä¼ªä»£ç è·Ÿæ¢å¤é™¤æ³•çš„ç¤ºä¾‹æ··åœ¨ä¸€èµ·è®²ï¼Œç»™æˆ‘æ™•å®Œäº†ã€‚\nå¯¹äºæ¢å¤é™¤æ³•ï¼Œä¸ºäº†é€‰æ‹©å•†éƒ½å¿…é¡»ç²¾ç¡®æ¯”è¾ƒ $R$ å’Œ $d$ çš„å…³ç³»ã€‚è€Œä¸”éšç€åŸºæ•° $r$ å˜å¤§ï¼Œæ¢å¤é™¤æ³•é¢ä¸´å¾ˆå¤§çš„æ¯”è¾ƒå‹åŠ›ï¼ˆæ¯”å¦‚æˆ‘çš„æ²Ÿæ§½è®¾è®¡ï¼‰ï¼Œéæ¢å¤é™¤æ³•çš„é€»è¾‘åˆ™å˜å¾—å¾ˆå¤æ‚ã€‚ SRT é™¤æ³•ä¸æƒ³åš 64 ä½çš„å‡æ³•ï¼Œå®ƒå¸Œæœ›åªé€šè¿‡çœ‹ $R$ å’Œ $d$ çš„é«˜å‡ ä½ï¼Œé€šè¿‡æŸ¥è¡¨å°±å¯ä»¥â€œçŒœâ€å‡ºä¸€ä¸ªå•†ï¼Œå¹¶ä¸”ä¿è¯åç»­è¿­ä»£å¯ä»¥ä¿®æ­£åˆ°æ­£ç¡®çš„ç»“æœã€‚\nåé¢è®¨è®ºçš„å¯¹è±¡å‡ä¸º Radix-4 SRT é™¤æ³•ã€‚\nå½’ä¸€åŒ–ä¸å¯¹é½\r#\rSRT é™¤æ³•è¦æ±‚å°†é™¤æ•°å·¦ç§»ï¼Œè®©é™¤æ•°ä½äº $\\left[ 0.5,1 \\right)$ ä¹‹é—´ã€‚å¹¶å¯¹é½è¢«é™¤æ•°ã€‚\nä¸ºä»€ä¹ˆä¸€å®šè¦æ§åˆ¶é™¤æ•° $d$ çš„èŒƒå›´å‘¢ï¼Ÿ\nSRT ç‹¬ç‰¹çš„ç‚¹åœ¨äºå•†æ•°é›†æ˜¯â€œå†—ä½™â€çš„ã€‚Radix-2 æ¢å¤é™¤æ³•çš„å•†æ•°é›†æ˜¯ $\\{ 0,1 \\}$ ï¼Œéæ¢å¤é™¤æ³•çš„å•†æ•°é›†æ˜¯ $\\{ -1,1 \\}$ ï¼Œæœ€ç»ˆå•†çš„è¡¨ç¤ºåº”è¯¥æ˜¯å”¯ä¸€çš„ã€‚ä½†æ˜¯ Radix-2 SRT çš„å•†æ•°é›†æ˜¯ $\\{ -1,0,1 \\}$ ï¼Œå­˜åœ¨å¯èƒ½çš„å¤šç§è¡¨ç¤ºã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå³ä½¿é«˜ä½çš„å•†ç®—çš„â€œä¸å‡†â€ï¼Œåç»­ä¹Ÿèƒ½æ•‘å›æ¥ã€‚\nSRT é™¤æ³•çš„è¿­ä»£å…¬å¼å¦‚ä¸‹ï¼Œå…¶ä¸­ $R_j$ æ˜¯å½“å‰ä½™æ•°ï¼Œ $r$ æ˜¯åŸºæ•°ï¼š $$R_{j+1} = r \\cdot R_j - q_{j+1} \\cdot d$$è€ƒè™‘ Radix-4 SRT é™¤æ³•ï¼šå•†æ•°é›†æ˜¯ $\\{ -2,-1,0,1,2 \\}$ ï¼Œå¦‚æœä½™æ•°è¿‡å¤§ï¼Œé  $- q_{j+1} \\cdot d$ è¿™é¡¹æ‹‰ä¸å›æ¥æ—¶ï¼Œæ˜¾ç„¶å•†å°±æœ‰é—®é¢˜äº†ã€‚å¿…é¡»è¦æ±‚è¿­ä»£æ–¹ç¨‹æ”¶æ•›ï¼Œé‚£ä¹ˆå¯ä»¥ç»™ä½™æ•°å®šä¸€ä¸ªç•Œé™ $|R| \\leq \\rho \\cdot d$ ã€‚\nè€ƒè™‘æœ€æç«¯çš„æƒ…å†µï¼šå½“å‰çš„ä½™æ•° $R_j$ å·²ç»è¾¾åˆ°äº†ä¸Šé™ $\\rho \\cdot d$ ï¼Œåšæœ€å¤§ä¿®æ­£ $R_{j+1} = r \\cdot (\\rho \\cdot d) - q_{max} \\cdot d$ ä»è¦æ»¡è¶³ $\\leq \\rho \\cdot d$ ï¼Œäºæ˜¯è§£ä¸ç­‰å¼ï¼š\n$$r \\cdot \\rho \\cdot d - q_{max} \\cdot d \\leq \\rho \\cdot d$$ å¾—åˆ° $\\rho \\geq \\frac{q_{max}}{r - 1}$ ï¼Œå¯¹äº Radix-4 ï¼Œè¿™ä¸ªå€¼æ˜¯ $\\frac{2}{3}$ ã€‚\nå›åˆ°ä¸ºä»€ä¹ˆè¦å½’ä¸€åŒ–é™¤æ•°çš„é—®é¢˜ï¼šå‡å¦‚ä¸å½’ä¸€ï¼Œé™¤æ•° $d$ æ²¡æœ‰ç¡®å®šçš„èŒƒå›´ã€‚å½“ $d$ å¾ˆå°æ—¶ï¼ŒSRT é™¤æ³•çš„æ”¶æ•›æ€§ä¸èƒ½ä¿è¯ï¼Œå¾ˆå¯èƒ½è¶Šé™¤ä½™æ•°è¶Šå¤§ã€‚å¦‚æœæƒ³è¦æé«˜é€‰å•†çš„å‡†ç¡®æ€§ï¼Œå°±å¾ˆéš¾åªä¾èµ– $R$ å’Œ $d$ çš„é«˜å‡ ä½ç¡®å®šé™¤æ•°ï¼Œæœ‰æ‚– SRT çš„ä¼˜åŒ–åˆè¡·ã€‚\nä½™æ•°çš„å­˜åœ¨å½¢å¼\r#\rä¹‹å‰æˆ‘ä»¬ç»™å‡ºäº† SRT é™¤æ³•çš„è¿­ä»£å…¬å¼ï¼Œå¦‚æœæ¯ä¸ªå‘¨æœŸæˆ‘ä»¬åšä¸€æ¬¡å‡æ³•ï¼Œé‚£å…¶å®å¹¶ä¸æ¯”éæ¢å¤é™¤æ³•å¥½å¤šå°‘ã€‚ä½†æ˜¯å¦‚æœä½™æ•° $R$ è¡¨ç¤ºæˆ $Sum(S) + Carry(C)$ ï¼Œè¿­ä»£å…¬å¼å°±å˜æˆäº†ä¸€ä¸ª 3 å˜ 2 çš„åŠ æ³•ã€‚æœ‰äº†ä¸ŠæœŸ Wallace Tree ç§¯ç´¯çš„ç»éªŒï¼Œæˆ‘ä»¬çŸ¥é“å…¨åŠ å™¨å°±èƒ½åšåˆ°ã€‚ $$(S_{j+1}, C_{j+1}) = CSA(r \\cdot S_j, r \\cdot C_j, -q_{j+1} \\cdot d)$$ä¹Ÿæ­£æ˜¯å› ä¸ºä½™æ•°æ˜¯ $(S, C)$ å½¢å¼ï¼Œæˆ‘ä»¬æ— æ³•å‡†ç¡®çš„çŸ¥é“å®ƒçš„å€¼ï¼ˆé™¤éåšä¸€æ¬¡ CPA ï¼Œä½†æ˜¯å¤ªæ…¢äº†ï¼‰ã€‚æˆ‘ä»¬åªèƒ½ä¾èµ– $S$ å’Œ $C$ çš„é«˜å‡ ä½æ¥â€œçŒœâ€è¿™ä¸ªå•†ï¼Œç”±äºèˆå¼ƒäº† $S$ å’Œ $C$ çš„ä¸€äº›ä½ä½ï¼Œæˆ‘ä»¬ç›¸å½“äºå¿½ç•¥äº†ä½ä½ä¼šäº§ç”Ÿçš„æœ€å¤§è¿›ä½ã€‚æˆªæ–­ä¹‹åå¾—åˆ°çš„æ˜¯ä¸€ä¸ªä½™æ•°çš„èŒƒå›´ã€‚\nä¹‹å‰æˆ‘ä»¬æåˆ°ï¼Œå› ä¸ºå•†æ•°é›†çš„å†—ä½™ï¼Œæˆ‘ä»¬åœ¨é€‰æ‹©å•†æ•°æ—¶å…¶å®æ˜¯æœ‰å®¹é”™çš„ã€‚å¯ä»¥ç†è§£æˆ $\\{ -2,-1,0,1,2 \\}$ é‡Œæ¯ä¸ªå•†æ•°éƒ½å¯¹åº”ä¸€ç‰‡åŒºåŸŸï¼Œåªè¦ $R$ å’Œ $d$ è½åœ¨åŒºåŸŸå†…ï¼Œé€‰æ‹©å¯¹åº”çš„ $q$ å°±æ˜¯å®‰å…¨çš„ï¼ˆè¿­ä»£æ”¶æ•›ï¼‰ã€‚å¹¶ä¸”è¿™äº›å•†æ•°å¯¹åº”çš„åŒºåŸŸä¼šæœ‰ä¸€äº›é‡å ï¼Œåœ¨é‡å åŒºå°±æœ‰å¤šç§å•†æ•°é€‰æ‹©ã€‚æˆ‘ä»¬æ‹¿åˆ°çš„ $R$ å’Œ $d$ éƒ½ä¼šæœ‰ä¸€å®šè¯¯å·®ï¼Œä½†åªè¦è¯¯å·®æ¯”é‡å åŒºå°ï¼Œé€‰çš„å•†å°±è¿˜æ˜¯å®‰å…¨çš„ã€‚\næˆªæ–­ä¿ç•™çš„ä½æ•°è¶Šå¤šï¼Œè¯¯å·®è¶Šå°ã€‚ XiangShan çœ‹äº†ä½™æ•°çš„é«˜ 7 ä½å’Œé™¤æ•°çš„é«˜ 4 ä½ï¼Œè¿™æ—¶è¯¯å·®å·²ç»å°äºé‡å åŒºäº†ã€‚\næ‰€è°“çš„ QDS å°±æ˜¯é€‰å–å•†æ•°çš„æ¨¡å—ï¼Œåšå¥½è¡¨åæŸ¥è¡¨å°±è¡Œã€‚\n#\rç†è§£ SRT é™¤æ³•è¿˜æ˜¯æœ‰ç‚¹éš¾ï¼Œè¯´å®è¯æ²¡æœ‰ç‰¹åˆ«å¥½çš„èµ„æ–™ã€‚\nwikipedia ä¸Šæ¢å¤é™¤æ³•å’Œéæ¢å¤é™¤æ³•è®²å¾—éƒ½æŒºè¯¦ç»†ï¼Œè¿˜é™„äº†ä¼ªä»£ç ï¼Œä½†æ˜¯ SRT å†™çš„å¾ˆå«ç³Šã€‚æˆ‘ä¸»è¦çš„èµ„æ–™æ¥æºä¹Ÿå°±æ˜¯ XiangShan å’Œåˆ«äººçš„åšå®¢ï¼Œå¾ˆéš¾è¯´æˆ‘çœŸçš„ç†è§£äº† SRT é™¤æ³•ï¼Œè‡³å°‘åœ¨ç¡¬ä»¶å®ç°ä¸Šè¿˜æœ‰å¾ˆå¤šç»†èŠ‚æˆ‘ä¸äº†è§£ã€‚\næœ¬æ–‡çš„ä¸»è¦ç›®çš„è¿˜æ˜¯ç ”ç©¶ SRT é™¤æ³•çš„ç†è®ºåŸºç¡€ï¼Œä¸ºä»€ä¹ˆè¦æœ‰å†—ä½™çš„å•†æ•°é›†ï¼Ÿä¸ºä»€ä¹ˆå¯ä»¥åªå‡­é«˜ä½é€‰å•†ï¼Ÿå¸Œæœ›è¿™äº›é—®é¢˜åœ¨çœ‹å®Œæœ¬æ–‡åèƒ½æœ‰ç­”æ¡ˆã€‚è‡³äºè¡¨æ€ä¹ˆåšï¼Œè¿­ä»£æ€ä¹ˆå†™ï¼Œå¥½åƒä¹Ÿéƒ½åªæ˜¯æ¯”è¾ƒ technical çš„äº‹ï¼Œæˆ‘æ˜¯ä¸å¤ªæ„Ÿå…´è¶£çš„ã€‚\nä¹‹åå¤§æ¦‚è¦è¿œç¦» HDL ä¸€æ®µæ—¶é—´ï¼Œå…¶å®è¿™å‡ ç¯‡æ–‡ç« éƒ½æ˜¯åœ¨ä¸º CPU å¡«å‘ï¼Œç„¶è€Œé‚£ä¸¤å¨å±å±±éƒ½å·²ç»ç•™åœ¨ä¸Šä¸ªå­¦æœŸäº†ï¼Œåˆ°æ­¤ä¹Ÿç®—ä»è‡³ä¹‰å°½ã€‚åœç¬”äº 27 æ—¥å‡Œæ™¨ 1 ç‚¹ï¼Œå¤œå¤ªæ·±ï¼Œæˆ‘è¦ç¡åŠ›ã€‚\n","date":"26 January 2026","externalUrl":null,"permalink":"/posts/srt-division/","section":"Posts","summary":"","title":"SRT Division","type":"posts"},{"content":"å¹»å½±å¿è€…å‰æƒ…æè¦ï¼šWallace Tree (1)\né¸½äº†å‡ å¤©ï¼ŒæœŸé—´æœ¬æ¥æƒ³ä¿®ä¿®ç½‘ç«™çš„ç¾å·¥ï¼Œå¯æƒœæ‘†äº†ã€‚æœ€ååªåšäº†ä¸€ä¸ª Music Playerï¼Œè¿˜å› ä¸ºç½‘é¡µæ˜¯é™æ€çš„ä¸å¥½å…¨å±€æ’­æ”¾ï¼ˆç¬‘ï¼‰ã€‚ä¸»é¡µæ”¾çš„æ˜¯æˆ‘çš„ç½‘æ˜“äº‘çº¢å¿ƒæ­Œå•ï¼Œå¦‚æœä½ æœ‰è·Ÿæˆ‘ç›¸è¿‘çš„å®¡ç¾ï¼ŒI will feel happyğŸ˜€ã€‚\næœ¬æ–‡ä¸»è¦å¡«ä¸€ä¸‹ä¸Šæ¬¡çš„å‘ï¼Œè®²ä¸€ä¸‹ XiangShan çš„ä¹˜æ³•å™¨ã€‚é‡‡ç”¨çš„æ˜¯ nanhu ç‰ˆçš„ä»£ç ï¼Œå®Œæ•´ä»£ç åœ¨è¿™é‡Œã€‚ä¹‹åä¼šåˆ’åˆ†æˆå‡ ä¸ªéƒ¨åˆ†ç»†è®²ä¸€ä¸‹å…·ä½“å®ç°ã€‚\nBefore Reading\r#\rä¸€æ–‡ä¸€æ­Œä¹Ÿç®—æ˜¯æƒ¯ä¾‹äº†ï¼Œä¹Ÿæ˜¯æˆ‘çº¢å¿ƒçš„æ›²å­ï¼Œæ­Œå•å¤ªå¤§é¦–é¡µä¸ä¸€å®šåˆ·å¾—åˆ°ï¼Œå°±æŒ‚åœ¨æ–‡ç« é‡Œå®‰åˆ©äº†ã€‚\nRewrite æ˜¯æˆ‘å¾ˆå–œæ¬¢çš„ä½œå“ã€‚ä»Šå¤©çªç„¶å‘ç° Fall in the Dark ä¹Ÿæ˜¯è¿™ä½æ­Œå§¬å”±çš„ï¼Œå®é™…ä¸œ gal å…±è£ï¼ˆå–œï¼‰ã€‚\nBooth ç¼–ç \r#\ræˆ‘ä»¬ä¸Šæ¬¡è®²äº†æœ€ naive çš„äºŒè¿›åˆ¶ä¹˜æ³•ï¼Œä¹Ÿå°±æ˜¯ç”Ÿæˆéƒ¨åˆ†ç§¯ï¼ŒæŠŠ 32 ä½ä¹˜æ³•å˜æˆäº† 32 æ¬¡åŠ æ³•ã€‚æˆ‘ä»¬æ³¨æ„åˆ°ï¼Œå¯¹äºäºŒè¿›åˆ¶ä¹˜æ³• $A\\times B$ ï¼Œå¦‚æœ $B$ çš„ç¬¬ $i$ ä½æ˜¯ 0ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å¿½ç•¥è¿™ä¸€ä½äº§ç”Ÿçš„éƒ¨åˆ†ç§¯ï¼ˆä¸º 0ï¼‰ã€‚\nä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä¹˜æ•° $B=00111110$ ï¼Œå¦‚æœæŒ‰ç…§ naive çš„åšæ³•ï¼Œéœ€è¦å°† 5 ä¸ªéƒ¨åˆ†ç§¯ç›¸åŠ ã€‚ä½†æ˜¯æˆ‘ä»¬åœ¨å°å­¦é˜¶æ®µå°±å­¦è¿‡ï¼š$114514\\times 99=114514\\times \\left( 100-1 \\right) =11451400-114514$ ï¼Œè¿™æ ·å¤„ç†ä¼šå¥½ç®—å¾ˆå¤šã€‚åœ¨äºŒè¿›åˆ¶çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç±»ä¼¼çš„æœ‰ï¼š $$ B=\\left( 00111110 \\right) _2=2^5+2^4+2^3+2^2+2^1=2^6-2^1=\\left( 010000\\overline{1}0 \\right) _2 $$ å…¶ä¸­ $\\overline{1}$ è¡¨ç¤º $-1$ ã€‚æ³¨æ„åˆ°æˆ‘ä»¬æŠŠä¸€ä¸²è¿ç»­çš„1æ¶ˆæ‰äº†ï¼Œè¿™æ ·åªä¼šäº§ç”Ÿä¸¤ä¸ªéƒ¨åˆ†ç§¯ã€‚\nRadix-2 Booth\r#\rä¸Šé¢æ˜¯å¾ˆç¬¦åˆäººç±»æ™ºæ…§çš„ä¼˜åŒ–ï¼Œæˆ‘ä»¬è¿›è¡Œæ¨å¹¿ã€‚å‡è®¾ä¹˜æ³• $A\\times B$ ï¼Œæ³¨æ„åˆ°ï¼š $$ A=a_{n-1}a_{n-2}...a_1a_0\\left( a_{-1} \\right) $$ $$ =a_{n-1}\\times \\left( -2^{n-1} \\right) +a_{n-2}\\times 2^{n-2}...+a_0\\times 2^0\\ \\text{ï¼ˆè¡¥ä½çš„}a_{-1}=0\\text{ï¼‰} $$ $$ =\\left( a_{n-2}-a_{n-1} \\right) \\times 2^{n-1}+\\left( a_{n-3}-a_{n-2} \\right) \\times 2^{n-2}...+\\left( a_0-a_1 \\right) \\times 2^1+\\left( a_{-1}-a_0 \\right) \\times 2^0 $$ç”±ä¸Šå¼ï¼Œå¯ä»¥åšå¦‚ä¸‹ç¼–ç ï¼š\næ¯æ¬¡ç§»åŠ¨ 1 ä½ï¼Œè§‚å¯Ÿ 2 ä½ï¼ˆå½“å‰ä½ $a_i$ ä¸ä½ä½ç›¸é‚»ä½ $a_{i-1}$ï¼‰ã€‚\nå½“å‰ä½ $a_i$ å³é‚»ä½ $a_{i-1}$ è§‚å¯Ÿåˆ°çš„æ¨¡å¼ æ“ä½œå€¼ å¯¹è¢«ä¹˜æ•° $B$ çš„æ“ä½œ 0 0 è¿ç»­çš„ 0 $0$ æ— æ“ä½œ 0 1 1 åºåˆ—ç»“æŸ $+1$ åŠ ä¸Š $B$ 1 0 1 åºåˆ—å¼€å§‹ $-1$ å‡å» $B$ (åŠ è¡¥ç ) 1 1 è¿ç»­çš„ 1 $0$ æ— æ“ä½œ è¿™å°±æ˜¯ Radix-2 Booth ç¼–ç ï¼Œæ¯æ¬¡ç§»åŠ¨ä¸€ä½ï¼Œè§‚å¯Ÿä¸¤ä½ã€‚\nRadix-2 Booth ç¡®å®èƒ½ä¼˜åŒ–æ‰ä¹‹å‰ä¾‹å­ä¸­è¿ç»­çš„ 1 ï¼Œä½†æ˜¯å½“ 1 æ˜¯å­¤ç«‹å‡ºç°çš„æ—¶å€™ï¼ˆæ¯”å¦‚ 010 ï¼‰ï¼Œéƒ¨åˆ†ç§¯åè€Œå˜å¤šäº†ã€‚ä¸‹é¢è®²çš„ Radix-4 Booth å°±ä¸ä¼šå‡ºç°è¿™ç§é—®é¢˜ã€‚\nRadix-4 Booth\r#\rå¦‚æœä½ çš„æ³¨æ„åŠ›å†å¥½ä¸€äº›ï¼Œä¼šå‘ç°ï¼š $$ A=\\left( a_{2n+1}a_{2n} \\right) a_{2n-1}a_{2n-2}...a_1a_0\\left( a_{-1} \\right) $$ ï¼ˆå…¶ä¸­ $a_{-1}$ æ˜¯è¡¥ä½çš„0ï¼Œ $a_{2n+1},a_{2n}$ ç”±ç¬¦å·æ‰©å±•å¾—åˆ°ã€‚ï¼‰\n$$ A=a_{2n-1}\\times \\left( -2^{2n-1} \\right) +a_{2n-2}\\times 2^{2n-2}...+a_0\\times 2^0 $$ $$ =\\left( a_{2n-1}+a_{2n}-2a_{2n+1} \\right) \\times 2^{2n}+\\left( a_{2n-3}+a_{2n-2}-2a_{2n-1} \\right) \\times 2^{2n-2}+ $$ $$ ...+\\left( a_1+a_2-2a_3 \\right) \\times 2^2+\\left( a_{-1}+a_0-2a_1 \\right) \\times 2^0 $$ $$ =\\sum_{i=0}^n{\\left( a_{2i-1}+a_{2i}-2a_{2i+1} \\right) \\cdot 2^{2i}} $$ç”±ä¸Šå¼ï¼Œæˆ‘ä»¬å¯ä»¥ä¸€æ¬¡ç§»åŠ¨ä¸¤ä½ï¼Œè§‚å¯Ÿä¸‰ä½ï¼Œåšå¦‚ä¸‹ç¼–ç ï¼š\n3ä½ç¼–ç çª—å£ $(a_{i+1}, a_i, a_{i-1})$ ä»£è¡¨çš„æ“ä½œå€¼ å¯¹åº”ä»£ç å˜é‡ ç¡¬ä»¶å®ç°é€»è¾‘ 000 $0$ 0.U ä¿æŒå…¨ 0 001 $+1$ b_sext åŠ è¢«ä¹˜æ•°åŸç  010 $+1$ b_sext åŠ è¢«ä¹˜æ•°åŸç  011 $+2$ bx2 è¢«ä¹˜æ•°å·¦ç§» 1 ä½ 100 $-2$ neg_bx2 è¢«ä¹˜æ•°å–åå·¦ç§» 1 ä½ 101 $-1$ neg_b åŠ è¢«ä¹˜æ•°è¡¥ç  110 $-1$ neg_b åŠ è¢«ä¹˜æ•°è¡¥ç  111 $0$ 0.U ä¿æŒå…¨ 0 XiangShan ä¹˜æ³•å™¨å°±æ˜¯é€šè¿‡ Radix-4 Booth ç®—æ³•ç”Ÿæˆéƒ¨åˆ†ç§¯ã€‚å®ƒåœ¨æ±‚è¡¥ç å’Œæ‹¼æ¥éƒ¨åˆ†ç§¯çš„è¿‡ç¨‹ä¸­è¿˜æœ‰ä¸€äº›å°å·§æ€ï¼Œå°±ä¸è¯¦ç»†å†™äº†ï¼Œå¯ä»¥ç›´æ¥çœ‹è´´åœ¨ä¸‹é¢çš„ä»£ç ï¼š\nval b_sext, bx2, neg_b, neg_bx2 = Wire(UInt((len\u0026#43;1).W)) b_sext := SignExt(b, len\u0026#43;1) bx2 := b_sext \u0026lt;\u0026lt; 1 neg_b := (~b_sext).asUInt neg_bx2 := neg_b \u0026lt;\u0026lt; 1 val columns: Array[Seq[Bool]] = Array.fill(2*len)(Seq()) var last_x = WireInit(0.U(3.W)) for(i \u0026lt;- Range(0, len, 2)){ val x = if(i==0) Cat(a(1,0), 0.U(1.W)) else if(i\u0026#43;1==len) SignExt(a(i, i-1), 3) else a(i\u0026#43;1, i-1) val pp_temp = MuxLookup(x, 0.U)(Seq( 1.U -\u0026gt; b_sext, 2.U -\u0026gt; b_sext, 3.U -\u0026gt; bx2, 4.U -\u0026gt; neg_bx2, 5.U -\u0026gt; neg_b, 6.U -\u0026gt; neg_b )) val s = pp_temp(len) val t = MuxLookup(last_x, 0.U(2.W))(Seq( 4.U -\u0026gt; 2.U(2.W), 5.U -\u0026gt; 1.U(2.W), 6.U -\u0026gt; 1.U(2.W) )) last_x = x val (pp, weight) = i match { case 0 =\u0026gt; (Cat(~s, s, s, pp_temp), 0) case n if (n==len-1) || (n==len-2) =\u0026gt; (Cat(~s, pp_temp, t), i-2) case _ =\u0026gt; (Cat(1.U(1.W), ~s, pp_temp, t), i-2) } for(j \u0026lt;- columns.indices){ if(j \u0026gt;= weight \u0026amp;\u0026amp; j \u0026lt; (weight \u0026#43; pp.getWidth)){ columns(j) = columns(j) :\u0026#43; pp(j-weight) } } } åˆ—å‹ç¼©ä¹˜æ³•\r#\rä¸Šä¸€ç¯‡æ–‡ç« ä»‹ç»äº† Wallace Tree çš„æ€æƒ³ï¼Œç®€å•æ¥è¯´å°±æ˜¯åˆ©ç”¨å…¨åŠ å™¨å°† 3 ä¸ªéƒ¨åˆ†ç§¯å‹ç¼©æˆ 2 ä¸ªã€‚æ¯å±‚éƒ½èƒ½å®ç°ä¸€æ¬¡ 3:2 çš„å‹ç¼©ï¼Œåœ¨ $O(\\log N)$ çš„å±‚æ•°å†…å°±èƒ½å‹ç¼©åˆ°åªå‰© 2 ä¸ªéƒ¨åˆ†ç§¯ç›¸åŠ ã€‚\nä»¥ 32 ä½ä¹˜æ³•ä¸ºä¾‹ã€‚æ³¨æ„åˆ°æ¯ä¸€ä¸ª 3:2 å‹ç¼©ï¼Œéœ€è¦ä¸€ä¸ª 64 ä½å‹ç¼©å™¨ã€‚ä½†å…¶å®å¾ˆå¤šæ—¶å€™ä½ä½éƒ½æ˜¯ç©ºçš„ï¼Œä¹Ÿå°±æ˜¯ä¸€ç›´åš $+0$ ï¼Œä¼šæµªè´¹ç›¸å½“ä¸€éƒ¨åˆ†çš„ç¡¬ä»¶èµ„æºã€‚\nè¿™æ˜¯ wikipedia ä¸Šæ‘˜ä¸‹æ¥çš„å›¾ï¼Œç”Ÿæˆçš„éƒ¨åˆ†ç§¯å…¶å®å°±ç±»ä¼¼è¿™æ ·ï¼Œæ›´åƒæ˜¯ä¸€ä¸ªå¹³è¡Œå››è¾¹å½¢ã€‚å›¾ä¸­å…¶å®æ˜¯åœ¨æŒ‰è¡Œå‹ç¼©ï¼ˆæ¯ä¸‰è¡Œåšä¸€ç»„å‹ç¼©ï¼‰ï¼Œä½†æ˜¯è¿™æ ·æ˜æ˜¾æµªè´¹äº†å·¦ä¸Šè§’å’Œå³ä¸‹è§’çš„è®¡ç®—ç©ºç™½ã€‚\nå¦‚æœæ¢ä¸ªè§’åº¦çœ‹ï¼Œç”¨å…¨åŠ å™¨åšå‹ç¼©é¿å…äº†è¿›ä½ä¼ æ’­çš„å»¶è¿Ÿï¼Œé‚£å®Œå…¨å¯ä»¥æŠŠæ¯ä¸€åˆ—è§†ä½œçš„å‹ç¼©è¿‡ç¨‹æŠ½ç¦»å‡ºæ¥ï¼Œä¸å†å—â€œè¡Œâ€çš„é™åˆ¶ã€‚å½“ç„¶æ¯ä¸€åˆ—åœ¨å‹ç¼©è¿‡ç¨‹ä¸­ï¼Œä¼šæ¥æ”¶æ¥è‡ªåä¸€åˆ—çš„è¿›ä½ï¼Œä¹Ÿä¼šè¿›ä½ç»™å‰ä¸€åˆ—ã€‚æœ€ç»ˆç›®æ ‡æ˜¯å‹ç¼©åˆ°æ¯ä¸€åˆ—éƒ½ä¸è¶…è¿‡ä¸¤ä¸ªã€‚\naddOneColumn\r#\rdef addOneColumn(col: Seq[Bool], cin: Seq[Bool]): (Seq[Bool], Seq[Bool], Seq[Bool]) = { var sum = Seq[Bool]() var cout1 = Seq[Bool]() var cout2 = Seq[Bool]() col.size match { case 1 =\u0026gt; // do nothing sum = col \u0026#43;\u0026#43; cin case 2 =\u0026gt; val c22 = Module(new C22) c22.io.in := col sum = c22.io.out(0).asBool \u0026#43;: cin cout2 = Seq(c22.io.out(1).asBool) case 3 =\u0026gt; val c32 = Module(new C32) c32.io.in := col sum = c32.io.out(0).asBool \u0026#43;: cin cout2 = Seq(c32.io.out(1).asBool) case 4 =\u0026gt; val c53 = Module(new C53) for((x, y) \u0026lt;- c53.io.in.take(4) zip col){ x := y } c53.io.in.last := (if(cin.nonEmpty) cin.head else 0.U) sum = Seq(c53.io.out(0).asBool) \u0026#43;\u0026#43; (if(cin.nonEmpty) cin.drop(1) else Nil) cout1 = Seq(c53.io.out(1).asBool) cout2 = Seq(c53.io.out(2).asBool) case n =\u0026gt; val cin_1 = if(cin.nonEmpty) Seq(cin.head) else Nil val cin_2 = if(cin.nonEmpty) cin.drop(1) else Nil val (s_1, c_1_1, c_1_2) = addOneColumn(col take 4, cin_1) val (s_2, c_2_1, c_2_2) = addOneColumn(col drop 4, cin_2) sum = s_1 \u0026#43;\u0026#43; s_2 cout1 = c_1_1 \u0026#43;\u0026#43; c_2_1 cout2 = c_1_2 \u0026#43;\u0026#43; c_2_2 } (sum, cout1, cout2) } addOneColumn çš„ä½œç”¨æ˜¯å‹ç¼©æŸä¸€åˆ—çš„éƒ¨åˆ†ç§¯ï¼Œå…·ä½“è®¾è®¡å¦‚ä¸‹ï¼š\nå¦‚æœè¿™ä¸€åˆ—åªæœ‰ 1 ä½ï¼Œæ— éœ€å‹ç¼©ã€‚ï¼ˆåŠ ä¸Šè¿›ä½ä¸è¶…è¿‡ 2 ä¸ªï¼‰ å¦‚æœæœ‰ 2 ä½ï¼Œä½¿ç”¨åŠåŠ å™¨ã€‚ï¼ˆ C22 å‹ç¼©å™¨ï¼Œè¾“å‡º sum ç•™åœ¨æœ¬åˆ—ï¼Œcarry è¿›ä½ï¼‰ å¦‚æœæœ‰ 3 ä½ï¼Œä½¿ç”¨å…¨åŠ å™¨ã€‚ï¼ˆ C32 å‹ç¼©å™¨ï¼Œè¾“å‡º sum ç•™åœ¨æœ¬åˆ—ï¼Œcarry è¿›ä½ï¼‰ å¦‚æœæœ‰ 4 ä½ï¼Œç»“åˆæ¥è‡ªä½ä½çš„ 1 ä¸ªè¿›ä½ï¼Œå‡‘æˆ 5 ä½ä½¿ç”¨ C53 å‹ç¼©å™¨ã€‚ å¦‚æœ addOneColumn çš„è¿™ä¸€åˆ—è¿˜æœ‰æ›´å¤šä½ï¼Œå°†ä¼šåˆ†ç»„åš addOneColumn ã€‚å‰å››ä½åˆ†æˆä¸€ç»„ï¼Œåé¢çš„æ‰€æœ‰ä½ä½œä¸ºç¬¬äºŒç»„ã€‚\nè¿™é‡Œç®€å•æä¸€ä¸‹ C53 çš„å®ç°ï¼Œå®ƒæ¥å— 4 ä¸ªæœ¬åˆ—è¾“å…¥å’Œ 1 ä¸ªä½ä½è¿›ä½ï¼Œè¾“å‡º 1 ä¸ª sum ç•™åœ¨æœ¬åˆ—ï¼Œå’Œ 2 ä¸ªå‘é«˜ä½çš„è¿›ä½ carry_1 carry_2ã€‚\n$sum=x_1\\oplus x_2\\oplus x_3\\oplus x_4\\oplus c_{in}$ ï¼ˆä¸€ç›´åŠ ï¼Œå¾ˆå¥½ç†è§£ï¼‰\n$carry_1 = \\text{Majority}(x_1, x_2, x_3)$ ï¼ˆå‰ä¸‰ä¸ªç›¸åŠ çš„è¿›ä½ï¼Œ $\\text{Majority}$ æŒ‡çš„æ˜¯ä¸‰è€…ä¸­å¤šæ•°å†³å®šï¼Œä¹Ÿå°±æ˜¯ $(x_1 \\wedge x_2) \\vee (x_2 \\wedge x_3) \\vee (x_1 \\wedge x_3)$ ï¼‰\n$carry_2 = \\text{Majority}(x_4, c_{in}, (x_1 \\oplus x_2 \\oplus x_3))$ ï¼ˆå‰ä¸‰ä¸ªçš„å’Œä¸ $x_4, c_{in}$ ç›¸åŠ çš„è¿›ä½ï¼‰\naddAll\r#\rä¹‹ååªè¦æ£€æŸ¥æ˜¯å¦è¾¾åˆ°å‹ç¼©å®Œæˆçš„æ¡ä»¶ï¼ˆæ¯åˆ—æœ€å¤šä¸¤ä½ï¼‰ï¼Œå¦‚æœæŸä¸€åˆ—æ²¡è¾¾åˆ°ï¼Œå°±è°ƒç”¨ addOneColumn è¿›è¡Œå‹ç¼©ã€‚\ndef addAll(cols: Array[Seq[Bool]], depth: Int): (UInt, UInt) = { if(max(cols.map(_.size)) \u0026lt;= 2){ val sum = Cat(cols.map(_(0)).reverse) var k = 0 while(cols(k).size == 1) k = k\u0026#43;1 val carry = Cat(cols.drop(k).map(_(1)).reverse) (sum, Cat(carry, 0.U(k.W))) } else { val columns_next = Array.fill(2*len)(Seq[Bool]()) var cout1, cout2 = Seq[Bool]() for( i \u0026lt;- cols.indices){ val (s, c1, c2) = addOneColumn(cols(i), cout1) columns_next(i) = s \u0026#43;\u0026#43; cout2 cout1 = c1 cout2 = c2 } val needReg = depth == 4 val toNextLayer = if(needReg) columns_next.map(_.map(x =\u0026gt; RegEnable(x, io.regEnables(1)))) else columns_next addAll(toNextLayer, depth\u0026#43;1) } } ä»£ç ä¸­çš„ cout1 cout2 æ˜¯ä¸ºäº†ç…§é¡¾åˆ° C53 å‹ç¼©å™¨ï¼Œå¯ä»¥åŒæ—¶å­˜ä¸¤ä½è¿›ä½ã€‚ä½†æ˜¯æŸåˆ—åœ¨è¿›è¡Œå‹ç¼©æ—¶åªä¼šç”¨åˆ° cout1 ä½œä¸ºä½ä½è¿›ä½ $c_{in}$ ï¼Œcout2 ä¼šç›´æ¥å­˜åˆ°æœ¬åˆ—å¹¶å‚ä¸ä¸‹ä¸€è½®å‹ç¼©ã€‚\næ·±åº¦ä¸º 4 æ—¶åˆ‡äº†ä¸€åˆ€ï¼Œå­˜è¿›å¯„å­˜å™¨ã€‚ XiangShan ä¸­çš„ä¹˜æ³•å ä¸¤ä¸ªæµæ°´çº§ï¼Œç­‰ä¸‹ä¸€ä¸ªå‘¨æœŸç»§ç»­å‹ç¼©ã€‚\nå†™åœ¨æœ€å\r#\rä»¥ä¸Šå°±æ˜¯ XiangShan çš„ä¹˜æ³•å™¨ï¼Œå¹¶æ²¡æœ‰é‚£ä¹ˆéš¾ç†è§£ï¼Œä½†æ˜¯å¾ˆç²¾å·§ã€‚é‡Œé¢ä¸€äº›å¾ˆç»†çš„ä¼˜åŒ–å’Œå°å·§æ€ç›¸å½“å€¼å¾—å“å‘³å‘¢ã€‚\nè¿™ç¯‡æ–‡ç« åŠ¨ç¬”äº 1 æœˆ 25 æ—¥ï¼Œä½†æ˜¯å†™å®Œå·²ç»æ˜¯ 1 æœˆ 26 å·äº†ã€‚ä¸­é€”å‡ºé—¨ï¼ˆè¢«è¿«ï¼‰å»é€›äº†é—¨å£çš„ç»¼åˆä½“ï¼Œæ„å¤–çš„æœ‰äººæ°”ã€‚ä¸Šæ¬¡æ¥å—äº¬è¿˜æ˜¯ 25 å¹´çš„æ˜¥èŠ‚ï¼Œä¸è¿‡å½“æ—¶å¥½åƒä¸€ç›´åœ¨å¾€æ–°è¡—å£é‚£å—è·‘ï¼ˆé¥­å±€æœ‰ç‚¹å¤šï¼‰ï¼Œå®¶é—¨å£çš„åè€Œæ²¡å»è¿‡ã€‚å†å¾€å‰ï¼Œå°è±¡å°±åœç•™åœ¨ 24 å¹´æš‘å‡äº†ï¼Œä¸è¿‡é‚£ä¸ªæ—¶å€™ç»¼åˆä½“ç–‘ä¼¼ï¼ˆï¼Ÿï¼‰è¿˜æ²¡å¼€ã€‚æ„Ÿå¹å»ä¸Šæµ·ä¸€å¹´åŠï¼Œå—é€šå—äº¬éƒ½å˜å¾—å¾ˆé™Œç”Ÿã€‚ä¸è¿‡ä¸Šæµ·ä¹Ÿå¾ˆé™Œç”Ÿï¼Œä¸€å¹´åŠè¿›åŸææ€•æ²¡æœ‰ 5 æ¬¡ï¼ˆç¬‘ï¼‰ã€‚\nç»†æ•°äº†ä¸€ä¸‹ï¼Œå»äº†ä¸¤æ¬¡æ—¦ï¼ˆä¸€æ¬¡æ˜¯ä¾‹ä¼šï¼‰ï¼ŒåŠ ä¸Šä¸€æ¬¡å¹»å¥ã€‚å¹³å‡ä¸‹æ¥åŠå¹´è¿›ä¸€æ¬¡åŸï¼Œè¿›åŸè¿˜æ˜¯å› ä¸ºåŠè½¦ä¸‡ç…§é¡¾ä¸äº†ååƒ»çš„é—µè¡Œã€‚\nä¸Šæ¬¡å‡ºè¿œé—¨å¥½åƒè¿˜æ˜¯æš‘å‡æ—¶ Norb ä¸¾è¡Œçš„ç¥ç§˜å‡ºæ¸¸ã€‚é€‰åœ¨äº†ä¸Šæµ·æœ€çƒ­çš„å¤©ï¼Œå»äº†åŒæ ·æ˜¯éƒŠåŒºï¼ˆæ‰€ä»¥ä¸ç®—è¿›åŸï¼‰çš„ä¸œæ–¹ç»¿èˆŸï¼Œä¸€ç¾¤æ— èŠçš„å¤§å­¦ç‰²åœ¨ $35^{\\circ}\\mathrm{C}$ çš„æ— é®æŒ¡ç©ºåœ°ä¸Šèµ°å„ç§æ¡¥ï¼ˆå…¬å›­é‡Œå¾ˆå¸¸è§é‚£ç§ï¼Œå„ç§æŠ½è±¡æ¡¥èº«å’Œé€ å‹ï¼‰ã€‚æœ€åçƒ­çš„å®åœ¨å—ä¸äº† 11 ç‚¹æ²¡åˆ°å°±å»æ‰¾é¥­åƒäº†ï¼Œå»äº†ä¸€å®¶å¾ˆå®æƒ çš„å®¶å¸¸èœæ¥ç€ã€‚æœ€åå…¨å‘˜ä½“éªŒå¸‚åŸŸæœºåœºçº¿ï¼Œå¹¸å¥½æ²¡æ‰“è½¦å›å»ï¼Œæˆ‘åœ¨æ‰“è½¦æ¥çš„ä¸€ä¸ªå°æ—¶ä¸­å¾ˆåšéŸ§åœ°æ²¡æœ‰åå‡ºæ¥ã€‚\næœ‰ç‚¹ææ€–çš„æ˜¯åˆšæ‰ä¸ºäº†ç¡®è®¤æ²¡æ‰“é”™åœ°åæ‰“å¼€æœç´¢å¼•æ“ï¼Œå‘ç°å°±åœ¨æˆ‘ä»¬å»ä¹‹å‰ä¸€å‘¨ï¼Œä¸œæ–¹ç»¿èˆŸè¿˜å‡ºäº†äº‹æ•…ã€‚éš¾é“è¯´é‚£å¤©äººé‚£ä¹ˆå°‘ä¹Ÿä¸åªæ˜¯å› ä¸ºå¤©æ°”ï¼ˆï¼Ÿï¼‰ã€‚\nå¥½å§ï¼Œå›å¿†å°±æ­¢äºæ­¤ï¼Œæˆ‘éƒ½å¿˜äº†æ˜¯ä¸ºä»€ä¹ˆè€Œæ„Ÿæ…¨çš„äº†ã€‚è¯¸å›æ™šå®‰ã€‚\n","date":"25 January 2026","externalUrl":null,"permalink":"/posts/wallace-tree-2/","section":"Posts","summary":"","title":"Wallace Tree (2)","type":"posts"},{"content":"ä¸ºäº†åš CPU M-Extension çš„ Bonus æ¥è§¦åˆ°äº† Wallace Tree ä¹˜æ³•å™¨ï¼Œåæ¥çš„å®ç°ä¹ŸåŸºæœ¬æ˜¯å€Ÿé‰´çš„è¿™ç§ä¹˜æ³•ã€‚ç»“æœ cr çš„æ—¶å€™å› ä¸ºå‘¨æœŸè®¾è®¡ä¸å¤Ÿ balanced è¢« TA æ‹·æ‰“äº†ï¼Œä¹‹ååˆåœ¨ XiangShan ä¸Šæ‰¾åˆ°äº†ä¸€ä¸ªåŸºäº Wallace Tree çš„ä¹˜æ³•å™¨å®ç°ï¼Œæ„Ÿè§‰è‡ªå·±åšçš„é‚£ä¸ªè¿˜æ˜¯å¤ªä½çº§äº†ã€‚\nBefore Reading\r#\rå› ä¸ºæ²¡æå®šè‡ªåŠ¨æ’­æ”¾ï¼Œå°±åŠ³çƒ¦æ‰‹åŠ¨ç‚¹ä¸€ä¸‹å§ï¼Œä¸è¿‡ä¼°è®¡æ’‘ä¸åˆ°ä½ è¯»å®Œæœ¬æ–‡ï¼ˆç¬‘ï¼‰ã€‚\nåŸç†\r#\ræœ€ç®€å•çš„äºŒè¿›åˆ¶ä¹˜æ³•å¯èƒ½ä¹Ÿæ²¡æœ‰é‚£ä¹ˆ naive ï¼Œå¤§è‡´å¯ä»¥ç”¨ä¸‹é¢çš„å›¾æ¥è§£é‡Š: é€šè¿‡ç®€å•çš„åˆ†æå¯ä»¥çŸ¥é“ï¼Œåªéœ€è¦ç”¨ $B$ çš„æ¯ä¸€ä½åˆ†åˆ«ä¸ $A$ ç›¸ä¹˜å¾—åˆ° $width$ ä¸ªéƒ¨åˆ†ç§¯ï¼ˆå¹¶å·¦ç§»ï¼‰ï¼Œä¹‹åå°†å®ƒä»¬åŠ èµ·æ¥å°±å¯ä»¥å®ç°ä¹˜æ³•ã€‚\nå¾—åˆ°éƒ¨åˆ†ç§¯æ˜¯å¾ˆå¿«é€Ÿçš„è¿‡ç¨‹ï¼Œå¯¹äºç¬¬ $i$ ä½ï¼Œåªéœ€è¦å°† $B[i]$ å¤åˆ¶ $width$ ä½å¾—åˆ° å…¨0 æˆ– å…¨1ï¼Œä¹‹åä¸ $A$ åšä¸€æ¬¡ And æ“ä½œå³å¯ã€‚å…³é”®çš„ä¼˜åŒ–åœ¨äºç´¯åŠ ï¼Œå› ä¸ºåš 32 æ¬¡ CPA çš„è€—æ—¶æ˜¯ä¸èƒ½å¿å—çš„ã€‚\nWallace Tree ç»™å‡ºäº†ä¸€ä¸ªæ–¹æ¡ˆï¼š\nä¸€ä¸ª 3-2 å‹ç¼©å™¨æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå…¨åŠ å™¨ï¼Œæ¥å— 3 ä¸ªæ•° $a,b,c$ ä½œä¸ºè¾“å…¥ï¼Œè¾“å‡º 2 ä¸ªæ•° $sum$ å’Œ $carry$ã€‚æŠŠ $carry$ å·¦ç§»ä¸€ä½å $carry+sum=a+b+c$ (è¿™æ˜¯æ˜¾ç„¶çš„)ã€‚é€šè¿‡è¿™æ ·çš„ä¸€ä¸ª 3-2 å‹ç¼©å™¨æˆ‘ä»¬å®ç°äº†æŠŠä¸‰ä¸ªæ•°ç›¸åŠ å˜æˆä¸¤ä¸ªæ•°ç›¸åŠ ï¼Œå…¨åŠ å™¨çš„å„ä½ä¹‹é—´æ˜¯ç‹¬ç«‹çš„ï¼ˆæ¯ä¸€ä½éƒ½æœ‰ $sum=a \\oplus b \\oplus c$ï¼Œ$carry=(a \\wedge b) \\vee (b \\wedge c) \\vee (a \\wedge c)$ï¼‰ï¼Œé¿å…äº† CPA å› éœ€è¦ä½ä½å‘é«˜ä½ä¼ æ’­ä¿¡å·å¸¦æ¥çš„å»¶è¿Ÿã€‚\n32 ä¸ªéƒ¨åˆ†ç§¯é€šè¿‡ä¸€å±‚çš„å‹ç¼©å¯ä»¥å˜æˆ 22 ä¸ªï¼Œç»§ç»­é€å±‚å‹ç¼©æœ€ç»ˆåªå‰© 2 ä¸ªéƒ¨åˆ†ç§¯ï¼Œåšä¸€æ¬¡ CPA å³å¯ã€‚\næµæ°´çº§è®¾è®¡\r#\råœ¨æˆ‘å®ç°çš„ä¹˜æ³•å™¨ä¸­å¯¹äºä¸€æ¬¡ä¹˜æ³•ï¼Œè¦åšçš„å†…å®¹å¦‚ä¸‹:\né›¶æ‰©å±•/ç¬¦å·æ‰©å±•è‡³ $2*width$ ä½å®½ ç”Ÿæˆéƒ¨åˆ†ç§¯ï¼ˆ $B$ çš„æ¯ä¸€ä½å¹¶è¡Œåœ°ä¸ $A$ é€šè¿‡ ANDé—¨ï¼‰ éƒ¨åˆ†ç§¯å‹ç¼©ï¼ˆ 8 å±‚ï¼‰ ä¸€æ¬¡ CPA ï¼ˆç”¨è¶…å‰è¿›ä½åŠ æ³•å™¨å®ç° 64 ä½åŠ æ³•ï¼‰ æ³¨æ„ï¼šéƒ¨åˆ†ç§¯å‹ç¼©çš„å±‚ä¸å±‚ä¹‹é—´æ˜¯ä¸²è”çš„ï¼Œæ¯ä¸€å±‚éœ€è¦ç­‰å¾…ä¸Šä¸€å±‚çš„ä¿¡å·ï¼Œè¿™ä¼šå¯¼è‡´å‹ç¼©çš„æ€»æ—¶é—´è¿œæ¯”æ¯å±‚å‹ç¼©çš„æ—¶é—´å’Œè¦å¤§ã€‚æŠŠ 8 å±‚çš„å‹ç¼©å…¨éƒ¨æ”¾åœ¨ä¸€ä¸ªå‘¨æœŸå¹¶ä¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚\nåœ¨ M1 ä¸­ï¼Œå¤„ç†ç¬¦å·ä½å’Œç”Ÿæˆéƒ¨åˆ†ç§¯éƒ½ä¸ä¼šæœ‰å¤ªå¤šå»¶è¿Ÿï¼Œå®Œå…¨å¯ä»¥è¿›è¡Œ 2 å±‚å‹ç¼©ã€‚ å‹ç¼©çš„å¦ä¸€ä¸ªå¥½å¤„åœ¨äºï¼šæ›´å°‘çš„éƒ¨åˆ†ç§¯æ„å‘³ç€ M1 åˆ° M2 ä¹‹é—´å­˜å‚¨è¿™äº›ä¸­é—´ç»“æœçš„å¯„å­˜å™¨å¯ä»¥å‡å°‘ã€‚\ndef cycle_m1(self): \u0026#34;\u0026#34;\u0026#34; Execute EX_M1 stage: Partial Product Generation \u0026#43; 2 Levels of Compression This stage generates 32 partial products using AND gates, then performs Level 1 (32 â†’ 22) and Level 2 (22 â†’ 15) compression. \u0026#34;\u0026#34;\u0026#34; # Only process if stage 1 is valid with Condition(self.m1_valid[0] == Bits(1)(1)): # Read pipeline registers op1 = self.m1_op1[0] op2 = self.m1_op2[0] op1_signed = self.m1_op1_signed[0] op2_signed = self.m1_op2_signed[0] # ================================================================= # Step 1: Sign/Zero extend operands to 64 bits # ================================================================= op1_ext = sign_zero_extend(op1, op1_signed) # 64-bit extended op1 # ================================================================= # Step 2: Compute signed multiplication correction for MULH # When op2 is signed and negative (op2[31]=1), we need to correct # the result because the MSB represents -2^31 instead of \u0026#43;2^31. # The correction is: subtract op1 from the high 32 bits of result. # ================================================================= need_correction = op2_signed \u0026amp; op2[31:31] signed_correction = need_correction.select(op1, Bits(32)(0)) # ================================================================= # Step 3: Generate 32 Partial Products # For each bit i of op2: pp[i] = (op2[i] ? op1_ext : 0) \u0026lt;\u0026lt; i # ================================================================= # Generate all 32 partial products with correct shifting # Note: For a left shift by i bits, we concat zeros on the right pp0 = op2[0:0].select(op1_ext, Bits(64)(0)) pp1 = op2[1:1].select(concat(op1_ext[0:62], Bits(1)(0)), Bits(64)(0)) pp2 = op2[2:2].select(concat(op1_ext[0:61], Bits(2)(0)), Bits(64)(0)) pp3 = op2[3:3].select(concat(op1_ext[0:60], Bits(3)(0)), Bits(64)(0)) pp4 = op2[4:4].select(concat(op1_ext[0:59], Bits(4)(0)), Bits(64)(0)) pp5 = op2[5:5].select(concat(op1_ext[0:58], Bits(5)(0)), Bits(64)(0)) pp6 = op2[6:6].select(concat(op1_ext[0:57], Bits(6)(0)), Bits(64)(0)) pp7 = op2[7:7].select(concat(op1_ext[0:56], Bits(7)(0)), Bits(64)(0)) pp8 = op2[8:8].select(concat(op1_ext[0:55], Bits(8)(0)), Bits(64)(0)) pp9 = op2[9:9].select(concat(op1_ext[0:54], Bits(9)(0)), Bits(64)(0)) pp10 = op2[10:10].select(concat(op1_ext[0:53], Bits(10)(0)), Bits(64)(0)) pp11 = op2[11:11].select(concat(op1_ext[0:52], Bits(11)(0)), Bits(64)(0)) pp12 = op2[12:12].select(concat(op1_ext[0:51], Bits(12)(0)), Bits(64)(0)) pp13 = op2[13:13].select(concat(op1_ext[0:50], Bits(13)(0)), Bits(64)(0)) pp14 = op2[14:14].select(concat(op1_ext[0:49], Bits(14)(0)), Bits(64)(0)) pp15 = op2[15:15].select(concat(op1_ext[0:48], Bits(15)(0)), Bits(64)(0)) pp16 = op2[16:16].select(concat(op1_ext[0:47], Bits(16)(0)), Bits(64)(0)) pp17 = op2[17:17].select(concat(op1_ext[0:46], Bits(17)(0)), Bits(64)(0)) pp18 = op2[18:18].select(concat(op1_ext[0:45], Bits(18)(0)), Bits(64)(0)) pp19 = op2[19:19].select(concat(op1_ext[0:44], Bits(19)(0)), Bits(64)(0)) pp20 = op2[20:20].select(concat(op1_ext[0:43], Bits(20)(0)), Bits(64)(0)) pp21 = op2[21:21].select(concat(op1_ext[0:42], Bits(21)(0)), Bits(64)(0)) pp22 = op2[22:22].select(concat(op1_ext[0:41], Bits(22)(0)), Bits(64)(0)) pp23 = op2[23:23].select(concat(op1_ext[0:40], Bits(23)(0)), Bits(64)(0)) pp24 = op2[24:24].select(concat(op1_ext[0:39], Bits(24)(0)), Bits(64)(0)) pp25 = op2[25:25].select(concat(op1_ext[0:38], Bits(25)(0)), Bits(64)(0)) pp26 = op2[26:26].select(concat(op1_ext[0:37], Bits(26)(0)), Bits(64)(0)) pp27 = op2[27:27].select(concat(op1_ext[0:36], Bits(27)(0)), Bits(64)(0)) pp28 = op2[28:28].select(concat(op1_ext[0:35], Bits(28)(0)), Bits(64)(0)) pp29 = op2[29:29].select(concat(op1_ext[0:34], Bits(29)(0)), Bits(64)(0)) pp30 = op2[30:30].select(concat(op1_ext[0:33], Bits(30)(0)), Bits(64)(0)) pp31 = op2[31:31].select(concat(op1_ext[0:32], Bits(31)(0)), Bits(64)(0)) # ================================================================= # Step 4: Wallace Tree Compression Level 1 (32 â†’ 22 rows) # ================================================================= # Level 1: 32 â†’ 22 rows (10 groups of 3, 2 passthrough) s1_0, c1_0 = full_adder_64bit(pp0, pp1, pp2) s1_1, c1_1 = full_adder_64bit(pp3, pp4, pp5) s1_2, c1_2 = full_adder_64bit(pp6, pp7, pp8) s1_3, c1_3 = full_adder_64bit(pp9, pp10, pp11) s1_4, c1_4 = full_adder_64bit(pp12, pp13, pp14) s1_5, c1_5 = full_adder_64bit(pp15, pp16, pp17) s1_6, c1_6 = full_adder_64bit(pp18, pp19, pp20) s1_7, c1_7 = full_adder_64bit(pp21, pp22, pp23) s1_8, c1_8 = full_adder_64bit(pp24, pp25, pp26) s1_9, c1_9 = full_adder_64bit(pp27, pp28, pp29) # Passthrough: pp30, pp31 # Level 1 output: 22 rows total (10 sum outputs: s1_0..s1_9, 10 carry outputs: c1_0..c1_9, 2 passthrough: pp30, pp31) # ================================================================= # Step 5: Wallace Tree Compression Level 2 (22 â†’ 15 rows) # ================================================================= # Level 2: 22 â†’ 15 rows (7 groups of 3, 1 passthrough) s2_0, c2_0 = full_adder_64bit(s1_0, c1_0, s1_1) s2_1, c2_1 = full_adder_64bit(c1_1, s1_2, c1_2) s2_2, c2_2 = full_adder_64bit(s1_3, c1_3, s1_4) s2_3, c2_3 = full_adder_64bit(c1_4, s1_5, c1_5) s2_4, c2_4 = full_adder_64bit(s1_6, c1_6, s1_7) s2_5, c2_5 = full_adder_64bit(c1_7, s1_8, c1_8) s2_6, c2_6 = full_adder_64bit(s1_9, c1_9, pp30) # Passthrough: pp31 # Level 2 output: 15 rows total (7 sum outputs: s2_0..s2_6, 7 carry outputs: c2_0..c2_6, 1 passthrough: pp31) # ================================================================= # Store 15 intermediate rows in stage 2 pipeline registers # ================================================================= self.m2_valid[0] = Bits(1)(1) self.m2_result_high[0] = self.m1_result_high[0] self.m2_rd[0] = self.m1_rd[0] self.m2_signed_correction[0] = signed_correction # Store all 15 intermediate rows self.m2_row0[0] = s2_0 self.m2_row1[0] = c2_0 self.m2_row2[0] = s2_1 self.m2_row3[0] = c2_1 self.m2_row4[0] = s2_2 self.m2_row5[0] = c2_2 self.m2_row6[0] = s2_3 self.m2_row7[0] = c2_3 self.m2_row8[0] = s2_4 self.m2_row9[0] = c2_4 self.m2_row10[0] = s2_5 self.m2_row11[0] = c2_5 self.m2_row12[0] = s2_6 self.m2_row13[0] = c2_6 self.m2_row14[0] = pp31 # Clear stage 1 self.m1_valid[0] = Bits(1)(0) M2 åªéœ€è¦ç”¨ full_adder_64bit ç»§ç»­å‹ç¼©ï¼Œç›´åˆ°åªå‰©ä¸‹ä¸¤ä¸ªæ•° $sum$ å’Œ $carry$ å³å¯ã€‚\ndef cycle_m2(self): \u0026#34;\u0026#34;\u0026#34; Execute EX_M2 stage: Wallace Tree Compression Levels 3-8 (15 â†’ 2 rows) This stage continues Wallace Tree compression from 15 rows down to 2 rows. \u0026#34;\u0026#34;\u0026#34; # Only process if stage 2 is valid with Condition(self.m2_valid[0] == Bits(1)(1)): # Read all 15 intermediate rows from pipeline registers # From Level 2 output: s2_0..s2_6, c2_0..c2_6, pp31 s2_0 = self.m2_row0[0] c2_0 = self.m2_row1[0] s2_1 = self.m2_row2[0] c2_1 = self.m2_row3[0] s2_2 = self.m2_row4[0] c2_2 = self.m2_row5[0] s2_3 = self.m2_row6[0] c2_3 = self.m2_row7[0] s2_4 = self.m2_row8[0] c2_4 = self.m2_row9[0] s2_5 = self.m2_row10[0] c2_5 = self.m2_row11[0] s2_6 = self.m2_row12[0] c2_6 = self.m2_row13[0] pp31 = self.m2_row14[0] # ================================================================= # Wallace Tree Compression Levels 3-8 (15 â†’ 2 rows) # ================================================================= # Level 3: 15 â†’ 10 rows (5 groups of 3) s3_0, c3_0 = full_adder_64bit(s2_0, c2_0, s2_1) s3_1, c3_1 = full_adder_64bit(c2_1, s2_2, c2_2) s3_2, c3_2 = full_adder_64bit(s2_3, c2_3, s2_4) s3_3, c3_3 = full_adder_64bit(c2_4, s2_5, c2_5) s3_4, c3_4 = full_adder_64bit(s2_6, c2_6, pp31) # Level 3 output: 10 rows # Level 4: 10 â†’ 7 rows (3 groups of 3, 1 passthrough) s4_0, c4_0 = full_adder_64bit(s3_0, c3_0, s3_1) s4_1, c4_1 = full_adder_64bit(c3_1, s3_2, c3_2) s4_2, c4_2 = full_adder_64bit(s3_3, c3_3, s3_4) # Passthrough: c3_4 # Level 4 output: 7 rows # Level 5: 7 â†’ 5 rows (2 groups of 3, 1 passthrough) s5_0, c5_0 = full_adder_64bit(s4_0, c4_0, s4_1) s5_1, c5_1 = full_adder_64bit(c4_1, s4_2, c4_2) # Passthrough: c3_4 # Level 5 output: 5 rows # Level 6: 5 â†’ 4 rows (1 group of 3, 2 passthrough) s6_0, c6_0 = full_adder_64bit(s5_0, c5_0, s5_1) # Passthrough: c5_1, c3_4 # Level 6 output: 4 rows # Level 7: 4 â†’ 3 rows (1 group of 3, 1 passthrough) s7_0, c7_0 = full_adder_64bit(s6_0, c6_0, c5_1) # Passthrough: c3_4 # Level 7 output: 3 rows # Level 8: 3 â†’ 2 rows (final Wallace Tree compression) s8_final, c8_final = full_adder_64bit(s7_0, c7_0, c3_4) # Final 2 rows: s8_final, c8_final # ================================================================= # Store final 2 rows in stage 3 pipeline registers # ================================================================= self.m3_valid[0] = Bits(1)(1) self.m3_result_high[0] = self.m2_result_high[0] self.m3_rd[0] = self.m2_rd[0] self.m3_signed_correction[0] = self.m2_signed_correction[0] # Store the 2 final rows self.m3_row0[0] = s8_final self.m3_row1[0] = c8_final # Clear stage 2 self.m2_valid[0] = Bits(1)(0) M3 éœ€è¦æ³¨æ„ä¸€ä¸ªç¬¦å·ä¿®æ­£çš„é—®é¢˜ï¼š$product_{64} = sum + carry + (-correction \\ll 32)$ å¦‚æœæ­£å¸¸å»åšï¼Œä¼šå¤šä¸€ä¸ªå‡æ³•çš„å»¶è¿Ÿï¼ˆå¯ä»¥å•ç‹¬ä¸€ä¸ªå‘¨æœŸçš„ç¨‹åº¦ï¼‰ï¼Œä½†æ˜¯ä¸Šé¢çš„å†™æ³•ä¹Ÿè¡¨æ˜äº†æˆ‘ä»¬å¯ä»¥å°†å…¶è§†ä½œ 3 ä¸ªæ•°ç›¸åŠ ï¼Œç”¨ä¸€æ¬¡å…¨åŠ å™¨å°±å¯ä»¥å‹ç¼©æˆ 2 ä¸ªæ•°ç›¸åŠ ã€‚æœ€ååªç”¨ä¸€æ¬¡ CLA è·å¾—æœ€ç»ˆç»“æœã€‚\ndef cycle_m3(self): \u0026#34;\u0026#34;\u0026#34; Execute EX_M3 stage: Final Addition using Carry-Lookahead Adder (CLA) This stage completes the multiplication by adding the final 2 rows using a carry-lookahead adder, with signed correction integrated via 3:2 compression. \u0026#34;\u0026#34;\u0026#34; # Only process if stage 3 is valid and result is not already ready with Condition((self.m3_valid[0] == Bits(1)(1)) \u0026amp; (self.m3_result_ready[0] == Bits(1)(0))): # Read the 2 final rows from pipeline registers s8_final = self.m3_row0[0] c8_final = self.m3_row1[0] signed_correction = self.m3_signed_correction[0] # ================================================================= # Integrate signed correction using 3:2 compression # Instead of computing: product_64 = sum \u0026#43; carry, then high -= correction # We compute: product_64 = sum \u0026#43; carry \u0026#43; (-correction \u0026lt;\u0026lt; 32) # # To subtract correction from high 32 bits, we add the two\u0026#39;s complement: # -correction = ~correction \u0026#43; 1 # We place this in bits [32:63] and handle the \u0026#43;1 in the carry row # ================================================================= # Create the correction value as a 64-bit number positioned in high 32 bits # correction_neg_high represents ~signed_correction in bits [32:63] correction_inv = ~signed_correction # Inverted bits for two\u0026#39;s complement correction_neg_64 = concat(correction_inv, Bits(32)(0)) # Place in high 32 bits # For the \u0026#43;1 of two\u0026#39;s complement, we add 1 at bit 32 # This can be merged into the carry row at position 32 # Create a 64-bit value with 1 at bit position 32 (i.e., 0x100000000) correction_plus_one = Bits(64)(0x100000000) # 1 \u0026lt;\u0026lt; 32 # Use 3:2 compressor to merge s8_final, c8_final, and correction_neg_64 s9_0, c9_0 = full_adder_64bit(s8_final, c8_final, correction_neg_64) # Use another 3:2 compressor to merge s9_0, c9_0, and correction_plus_one s_final, c_final = full_adder_64bit(s9_0, c9_0, correction_plus_one) # ================================================================= # CLA (Carry-Lookahead Adder) - Final Addition # Now we have integrated the signed correction into the compression # ================================================================= product_64 = carry_lookahead_adder_64bit(s_final, c_final) # Select which 32 bits to return based on operation type partial_low = product_64[0:31].bitcast(Bits(32)) partial_high = product_64[32:63].bitcast(Bits(32)) result = self.m3_result_high[0].select( partial_high, # High 32 bits for MULH/MULHSU/MULHU partial_low # Low 32 bits for MUL ) # Store final result and mark as ready self.m3_result[0] = result self.m3_result_ready[0] = Bits(1)(1) # Clear valid flag since processing is complete self.m3_valid[0] = Bits(1)(0) é‡Œé¢å…¶å®è¿˜æœ‰å¾ˆå¤šå¯ä»¥ä¼˜åŒ–çš„åœ°æ–¹ï¼Œä½†æ˜¯é™äºä¸ªäººç›®å‰æ°´å¹³ï¼ˆä»¥åŠä¸æƒ³ä¸ºæ²Ÿæ§½çš„ Assassyn å†æŠ˜è…¾ï¼‰ï¼Œå¤§æ¦‚å°±åˆ°æ­¤ä¸ºæ­¢äº†ã€‚ä¸‹æ¬¡å¯èƒ½ä¼šå†™ä¸€äº›å…³äº XiangShan æ‰€å®ç°çš„ä¹˜æ³•å™¨çš„ä¸œè¥¿ï¼Œä¸è¿‡ä¸‹æ¬¡çš„äº‹å°±ä¸‹æ¬¡å†è¯´å§ï¼ˆç¬‘ï¼‰ã€‚\nSomething Unrelated\u0026hellip;\r#\ræ‰¾äº†ä¸€é¦–æ¯”è¾ƒé•¿çš„ï¼Œè¾¹çœ‹å¸–è¾¹å¬æ­Œå¾ˆä¸é”™çš„è¯´ã€‚\nï¼ˆbtw: èŠ±éƒ½æ˜¯çœŸå¥½å¬å•Šï¼Œæ€ä¹ˆæ”¹éƒ½å¥½å¬é‚£ç§ï¼ï¼‰\nä¹‹åæ‰¾ä¸ªæ—¶é—´æŠŠç½‘ç«™çš„ç¾å·¥ææå¥½å§ï¼Œç°åœ¨æš—è‰²è¿˜çœ‹çš„è¿‡å»ï¼Œæµ…è‰²ä¸‘çš„çœ‹ä¸ä¸‹å»ï¼ˆï¼‰ã€‚\n","date":"21 January 2026","externalUrl":null,"permalink":"/posts/wallace-tree-1/","section":"Posts","summary":"","title":"Wallace Tree (1)","type":"posts"},{"content":"\rBirthï¼\r#\rè¿™æ˜¯æˆ‘ç”¨ Blowfish æ­å»ºçš„åšå®¢ã€‚\nå¹¶ä¸æ˜¯æœ‰äº†ä»€ä¹ˆæƒ³è®°å½•çš„ä¸œè¥¿æ‰å¼€äº†è¿™ä¸ªBlogï¼Œè€Œæ˜¯è§‰å¾—è¿™ç§æ–¹å¼èƒ½pushè‡ªå·±å†™ä¸€ç‚¹ä¸œè¥¿ã€‚å…¶å®ä»PPCAçš„æ—¶å€™å°±åº”è¯¥å†™ç‚¹çš„ï¼Œä½†æ˜¯å†™å®ŒRay-Traceråæœ‰ç‚¹æ‘†ï¼Œä¹‹åå°±è¢«å„ç§ä¸å¯åçŠ¶çš„ä¸œè¥¿ç¡¬æ§åˆ°ç°åœ¨ï¼ˆæ‚²ï¼‰ã€‚å†™Blogæœ¬èº«æ˜¯ä¸ºäº†æ‰¾ç‚¹ä¹å­ï¼Œé¡ºæ‰‹è®°å½•ç‚¹ä¸œè¥¿ï¼Œåº”è¯¥ä¹Ÿæ˜¯æŒºå¥½çš„ã€‚\næˆ‘æ²¡æœ‰å†™æ—¥è®°çš„ä¹ æƒ¯ï¼Œä¹Ÿæ˜¯ç¬¬ä¸€æ¬¡å†™Blogï¼Œéš¾å…æœ‰ç‚¹æµæ°´è´¦ï¼Œæƒå½“æ˜¯è¯­è¨€èƒ½åŠ›çš„åº·å¤è®­ç»ƒå°±å¥½ã€‚è¿™ç¯‡ä¸€æ˜¯æµ‹è¯•ä¸‹ç½‘ç«™ï¼ŒäºŒæ˜¯äº¤ä»£ä¸€ä¸‹åšå®¢çš„ç¼˜ç”±ï¼Œåç»­ä¼°è®¡ä»€ä¹ˆéƒ½ä¼šå†™ç‚¹ï¼Œåˆ«å¤ªæ‡’å°±è¡Œï¼ˆç¬‘ï¼‰ã€‚\nå¬é¦–æ­Œå§\r#\ré«˜ä¸­æ—¶å¾ˆå–œæ¬¢è¿™å¼ ä¸“æ¥ç€ï¼Œè¿™é¦–ç¼–æ›²ä¹Ÿå¾ˆèˆ’æœã€‚æ˜¨å¤©æ—¥æ¨åˆåˆ·åˆ°ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆæ²¡æœ‰çº¢å¿ƒâ€¦â€¦\n","date":"19 January 2026","externalUrl":null,"permalink":"/posts/hello-world/","section":"Posts","summary":"","title":"Hello World","type":"posts"},{"content":"","externalUrl":null,"permalink":"/authors/","section":"Authors","summary":"","title":"Authors","type":"authors"},{"content":"","externalUrl":null,"permalink":"/categories/","section":"Categories","summary":"","title":"Categories","type":"categories"},{"content":"","externalUrl":null,"permalink":"/series/","section":"Series","summary":"","title":"Series","type":"series"},{"content":"","externalUrl":null,"permalink":"/tags/","section":"Tags","summary":"","title":"Tags","type":"tags"},{"content":"Hiï¼è¿™é‡Œæ˜¯ Youming çš„å°ç«™ï¼Œè®°å½•æ­£åœ¨è¿›è¡Œçš„å­¦ä¹ ã€æƒ³æ³•ä»¥åŠä¸€äº›ä¸ªäººç”Ÿæ´»ã€‚\næˆ‘ç›®å‰æ˜¯ä¸Šæµ·äº¤é€šå¤§å­¦ ACM ç­çš„ä¸€åæœ¬ç§‘ç”Ÿã€‚\nè¿˜åœ¨æ¢ç´¢ç ”ç©¶æ–¹å‘ã€‚ å–œæ¬¢éŸ³ä¹ã€åŠ¨æ¼«ä¸å‰§æƒ…ç±»æ¸¸æˆï¼Œå¯¹æ£‹ç±»å¾ˆæ„Ÿå…´è¶£ã€‚ å†™ä¸‹æ¥çš„ä¸œè¥¿ä¸»è¦æ˜¯ç»™æœªæ¥çš„è‡ªå·±å¤‡å¿˜ï¼Œä¹Ÿæ¬¢è¿äº¤æµã€‚ å¦‚æœä½ æƒ³è”ç³»æˆ‘ï¼Œå¯ä»¥å‘é‚®ä»¶åˆ° dxuanming@sjtu.edu.cnã€‚ è¿™ä¸ªé¡µé¢ä¼šæ…¢æ…¢æ‰©å……ï¼Œä¹‹åå‡†å¤‡æ”¾ä¸Šä¸€äº›å¸¸é©»ä¿¡æ¯ï¼Œä¾‹å¦‚æˆ‘æ­£åœ¨è¯»çš„ä¹¦ã€åšçš„é¡¹ç›®ä»¥åŠéŸ³ä¹æ­Œå•ã€‚æ•¬è¯·æœŸå¾…ã€‚\n","externalUrl":null,"permalink":"/about/","section":"å…³äº","summary":"","title":"å…³äº","type":"page"}]